<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafeter√≠as - Selector de Dispositivo</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0a84ff;
      --primary-dark: #0066cc;
      --bg: #f5f5f7;
      --surface: #ffffff;
      --text: #1d1d1f;
      --text-secondary: #86868b;
      --border: #d2d2d7;
      --success: #34c759;
      --danger: #ff3b30;
      --warning: #ff9500;
      --radius: 14px;
      --shadow: 0 2px 10px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 220px;
      background: var(--surface);
      padding: 24px 12px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .sidebar-header {
      padding: 0 8px 16px 8px;
      border-bottom: 2px solid var(--border);
      margin-bottom: 8px;
    }

    .sidebar-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .sidebar-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .cafe-button {
      padding: 16px 20px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      color: white;
      text-align: left;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: auto;
    }

    .cafe-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    .cafe-button.active {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
    }

    .add-cafe-btn {
      padding: 14px 20px;
      border: 2px dashed var(--primary);
      border-radius: 12px;
      background: transparent;
      color: var(--primary);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
      min-height: auto;
    }

    .add-cafe-btn:hover {
      background: rgba(10,132,255,0.1);
      border-style: solid;
    }

    /* Colores predefinidos para cafeter√≠as */
    .color-1 { background: #5ac8fa; }
    .color-2 { background: #34c759; }
    .color-3 { background: #ff3b30; }
    .color-4 { background: #ff9500; }
    .color-5 { background: #af52de; }
    .color-6 { background: #ff2d55; }
    .color-7 { background: #5856d6; }
    .color-8 { background: #ffcc00; color: #1d1d1f; }

    .main-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    .container {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 20px 32px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      font-family: inherit;
      font-size: 15px;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 48px;
      touch-action: manipulation;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 2px 8px rgba(10,132,255,0.3);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(10,132,255,0.4);
    }

    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg);
      border-color: var(--primary);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #d62b20;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    button:active {
      transform: scale(0.97);
    }

    /* Men√∫ hamburger para m√≥vil */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      background: var(--primary);
      border-radius: 50%;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(10,132,255,0.4);
      z-index: 1000;
      transition: all 0.3s;
    }

    .mobile-menu-toggle:active {
      transform: scale(0.95);
    }

    .mobile-cafes-menu {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-radius: 24px 24px 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      z-index: 999;
      max-height: 70vh;
      overflow-y: auto;
      padding: 24px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .mobile-cafes-menu.active {
      transform: translateY(0);
    }

    .mobile-cafes-menu-header {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mobile-cafes-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mobile-cafe-item {
      padding: 20px;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 600;
      border: none;
      color: white;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .mobile-cafe-item:active {
      transform: scale(0.98);
    }

    .cards-grid {
      display: none;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .card-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .card-meta {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: auto;
    }

    .card-actions {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .card:hover .card-actions {
      opacity: 1;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      min-height: unset;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: rgba(0,0,0,0.05);
      font-size: 18px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: rgba(0,0,0,0.1);
      transform: scale(1.05);
    }

    .icon-btn:active {
      transform: scale(0.95);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 32px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: modalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      font-size: 24px;
      font-weight: 700;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .form-input,
    select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 16px;
      font-family: inherit;
      background: var(--surface);
      color: var(--text);
      transition: all 0.2s;
      min-height: 52px;
    }

    .form-input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(10,132,255,0.1);
    }

    .table-container {
      overflow-x: auto;
      margin: 24px 0;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--surface);
    }

    th, td {
      padding: 16px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 200px;
    }

    th {
      background: var(--bg);
      font-weight: 700;
      font-size: 14px;
      color: var(--text);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    
    td:first-child {
      text-align: left;
      font-weight: 600;
      max-width: 150px;
      white-space: normal;
    }

    tbody tr:hover {
      background: rgba(10,132,255,0.05);
    }

    .qty-group {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px 0;
    }

    .qty-input {
      width: 100%;
      max-width: 120px;
      padding: 16px 12px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      border: 2.5px solid var(--border);
      border-radius: 12px;
      min-height: 60px;
      background: var(--surface);
      color: var(--text);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      touch-action: manipulation;
    }

    .qty-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 5px rgba(10,132,255,0.12);
      transform: scale(1.02);
      background: #ffffff;
    }
    
    .qty-input:active {
      transform: scale(0.98);
    }
    
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
      display: none;
    }
    
    .qty-input {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .product-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .product-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .product-name {
      flex: 2;
      font-weight: 600;
    }

    .product-price {
      flex: 1;
      text-align: center;
      color: var(--text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      background: var(--bg);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .stats-row {
      display: flex;
      gap: 16px;
      margin: 24px 0;
      flex-wrap: wrap;
    }

    .stat-card {
      flex: 1;
      min-width: 200px;
      background: var(--surface);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text);
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-top: 24px;
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .dashboard-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .dashboard-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }

    .dashboard-card-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .dashboard-card-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .dashboard-card-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 6px;
    }

    .dashboard-card-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .date-selector {
      background: var(--surface);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .date-selector-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    header.hidden {
      display: none;
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 20px;
      min-height: 40px;
    }

    .back-button:hover {
      background: var(--bg);
      border-color: var(--primary);
      transform: translateX(-4px);
    }

    .view-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .view-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
    }

    .view-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        display: none; /* Ocultar sidebar horizontal en m√≥vil */
      }

      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .mobile-cafes-menu {
        display: block;
      }

      .container {
        padding: 24px 16px;
        padding-bottom: 100px; /* Espacio para el bot√≥n flotante */
      }

      .header-content {
        padding: 20px 16px;
      }

      h1 {
        font-size: 28px;
        margin-bottom: 8px;
      }
      
      h2 {
        font-size: 24px;
        margin-bottom: 16px;
      }

      .dashboard-grid {
        gap: 16px;
        margin-top: 20px;
      }

      .dashboard-card {
        padding: 24px;
        border-radius: 16px;
      }

      .dashboard-card-title {
        font-size: 18px;
        margin-bottom: 12px;
      }

      .dashboard-card-value {
        font-size: 36px;
      }

      .week-selector-badge {
        font-size: 16px !important;
        padding: 16px 20px !important;
        border-radius: 12px !important;
      }

      .icon-btn {
        width: 50px !important;
        height: 50px !important;
        font-size: 20px !important;
        border-radius: 12px !important;
      }

      .btn-primary, .btn-secondary {
        padding: 16px 24px !important;
        font-size: 16px !important;
        min-height: 50px !important;
        border-radius: 12px !important;
      }

      .modal {
        padding: 24px;
      }

      .qty-input {
        max-width: 100%;
        min-height: 70px;
        font-size: 24px;
        padding: 20px 12px;
      }

      button {
        min-height: 56px;
        font-size: 17px;
        padding: 14px 24px;
        border-radius: 14px;
      }

      .btn-secondary, .btn-primary, .btn-danger, .btn-success {
        min-height: 56px;
        font-size: 17px;
        border-radius: 14px;
      }

      .dashboard-card {
        padding: 24px;
        border-radius: 18px;
      }

      .dashboard-card-value {
        font-size: 42px;
        margin-top: 8px;
      }

      .view-actions button {
        padding: 14px 24px;
        font-size: 16px;
        min-height: 52px;
        border-radius: 14px;
      }
      
      .back-button {
        padding: 14px 24px;
        font-size: 16px;
        min-height: 52px;
        border-radius: 14px;
        margin-bottom: 20px;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-input, .form-select {
        min-height: 52px;
        font-size: 16px;
        padding: 14px;
        border-radius: 12px;
      }
      
      .date-selector {
        gap: 12px;
        flex-wrap: wrap;
        padding: 16px;
        background: var(--surface);
        border-radius: 16px;
        margin-bottom: 20px;
      }
    }

    /* Estilos para vista m√≥vil - Lista de checkboxes */
    .mobile-order-view {
      display: none;
    }

    .mobile-date-header {
      background: var(--surface);
      padding: 20px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .mobile-date-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .mobile-products-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mobile-product-item {
      background: var(--surface);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      transition: all 0.2s;
      border: 3px solid transparent;
    }

    .mobile-product-item.checked {
      border-color: var(--success);
      background: rgba(52, 199, 89, 0.05);
    }

    .mobile-product-name {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
      flex: 1;
    }

    .mobile-checkbox {
      width: 60px;
      height: 60px;
      border: 3px solid var(--border);
      border-radius: 12px;
      background: var(--surface);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .mobile-checkbox.checked {
      background: var(--success);
      border-color: var(--success);
    }

    .mobile-checkbox-icon {
      font-size: 32px;
      color: white;
      display: none;
    }

    .mobile-checkbox.checked .mobile-checkbox-icon {
      display: block;
    }

    .mobile-sync-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 12px 20px;
      border-radius: 50px;
      box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
      font-size: 14px;
      font-weight: 600;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 1000;
    }

    .mobile-sync-indicator.show {
      display: flex;
    }

    /* Vista tablet - Solo lectura */
    .tablet-readonly-view {
      display: none;
    }

    .tablet-readonly-indicator {
      background: rgba(10,132,255,0.1);
      padding: 12px 20px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      text-align: center;
      color: var(--primary);
      font-weight: 600;
      border: 2px solid var(--primary);
    }

    .auto-refresh-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      animation: spin 2s linear infinite;
    }

    .text-center { text-align: center; }
    .text-secondary { color: var(--text-secondary); }
    .mb-16 { margin-bottom: 16px; }
    .mt-24 { margin-top: 24px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebarCafes">
    <div class="sidebar-header">
      <div class="sidebar-title">ü•ê Panfitri√≥n</div>
      <div class="sidebar-subtitle">CAFETER√çAS</div>
    </div>
    <button class="cafe-button" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 8px;" onclick="app.showDashboard()">
      <span>üè† Inicio</span>
    </button>
    <!-- Botones de cafeter√≠as se cargar√°n aqu√≠ -->
  </div>

  <div class="main-wrapper">
  <header>
    <div class="header-content">
      <div>
        <h1>ü•ê Panfitri√≥n</h1>
        <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
          <span style="font-size: 12px; color: var(--text-secondary); font-weight: 600;">üìÖ RANGO GENERAL:</span>
          <input type="date" id="globalDateStart" style="padding: 6px 10px; font-size: 13px; border: 2px solid var(--border); border-radius: 8px; min-height: 36px; width: 140px;">
          <span style="color: var(--text-secondary); font-weight: 600;">a</span>
          <input type="date" id="globalDateEnd" style="padding: 6px 10px; font-size: 13px; border: 2px solid var(--border); border-radius: 8px; min-height: 36px; width: 140px;">
          <span id="connectionStatus" style="margin-left: 12px; font-size: 11px; padding: 4px 10px; border-radius: 6px; font-weight: 600;"></span>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn-secondary" onclick="app.exportAllPDF()">üìÑ Exportar Todo</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- View: Dashboard/Inicio -->
    <div id="clientsView" class="view active">
      <h2 style="font-size: 32px; font-weight: 700; margin-bottom: 8px;">üìä Dashboard General</h2>
      <p style="color: var(--text-secondary); margin-bottom: 24px;">Resumen de todas las cafeter√≠as</p>

      <div class="date-selector" style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
        <button class="icon-btn" onclick="app.changeDashboardWeek(-1)" style="width: 44px; height: 44px; font-size: 18px;" title="Semana anterior">‚Üê</button>
        <div class="week-selector-badge" id="dashboardWeekRange" onclick="app.resetDashboardWeek()" style="cursor: pointer; padding: 12px 20px; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; font-size: 14px; font-weight: 600;">
          Cargando...
        </div>
        <button class="icon-btn" onclick="app.changeDashboardWeek(1)" style="width: 44px; height: 44px; font-size: 18px;" title="Semana siguiente">‚Üí</button>
        <span style="color: var(--text-secondary); font-size: 13px; font-weight: 500;">(Lunes a S√°bado)</span>
      </div>

      <div id="dashboardContent">
        <div class="dashboard-grid" id="dashboardGrid">
          <!-- Se cargar√°n las tarjetas aqu√≠ -->
        </div>
      </div>

      <div id="emptyState" class="empty-state hidden">
        <div class="empty-state-icon">üì¶</div>
        <h3>No hay cafeter√≠as</h3>
        <p>Crea tu primera cafeter√≠a o importa desde CSV</p>
        <button class="btn-primary mt-24" onclick="app.showClientModal()">Crear Cafeter√≠a</button>
      </div>
    </div>

    <!-- View: Pedidos -->
    <div id="ordersView" class="view">
      <button class="back-button" onclick="app.showDashboard()">
        ‚Üê Volver a Inicio
      </button>
      
      <div class="view-header">
        <div>
          <h2 class="view-title" id="ordersClientName">Cliente</h2>
          <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
            <button class="icon-btn" onclick="app.changeWeek(-1)" style="width: 32px; height: 32px; font-size: 16px;" title="Semana anterior">‚Üê</button>
            <span class="badge" id="ordersWeekRange" style="padding: 8px 16px; font-size: 14px; cursor: pointer;" onclick="app.resetToCurrentWeek()" title="Click para volver a la semana actual">Semana</span>
            <button class="icon-btn" onclick="app.changeWeek(1)" style="width: 32px; height: 32px; font-size: 16px;" title="Semana siguiente">‚Üí</button>
          </div>
        </div>
        <div class="view-actions">
          <button class="btn-secondary" onclick="app.editClient(app.currentClientIndex)" style="padding: 8px 16px; font-size: 13px; min-height: 36px;">‚úèÔ∏è Editar</button>
          <button class="btn-secondary" onclick="app.viewHistory()" style="padding: 8px 16px; font-size: 13px; min-height: 36px;">üìú Historial</button>
          <button class="btn-danger" onclick="app.resetWeek()" style="padding: 8px 16px; font-size: 13px; min-height: 36px;">üîÑ Reiniciar</button>
          <button class="btn-danger" onclick="app.deleteClient(app.currentClientIndex)" style="padding: 8px 16px; font-size: 13px; min-height: 36px;">üóëÔ∏è Eliminar</button>
          <button class="btn-success" onclick="app.exportWeek()" style="padding: 8px 16px; font-size: 13px; min-height: 36px;">üíæ Guardar</button>
        </div>
      </div>

      <div class="stats-row" style="margin-bottom: 24px;">
        <div class="stat-card">
          <div class="stat-label">Total Bruto</div>
          <div class="stat-value" id="grossTotal">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Regresados</div>
          <div class="stat-value" id="returnsTotal">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Neto</div>
          <div class="stat-value" id="netTotal">$0.00</div>
        </div>
      </div>

      <div class="table-container">
        <table id="ordersTable">
          <thead id="ordersTableHead"></thead>
          <tbody id="ordersTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- View: Historial -->
    <div id="historyView" class="view">
      <button class="back-button" onclick="app.showView('ordersView')">
        ‚Üê Volver a Pedidos
      </button>
      
      <div class="view-header">
        <h2 class="view-title" id="historyClientName">Historial</h2>
      </div>
      
      <div id="historyList"></div>
    </div>

    <!-- View: M√≥vil - Toma de Pedidos Simple -->
    <div id="mobileOrderView" class="view mobile-order-view">
      <button class="back-button" onclick="app.showView('clientsView')">
        ‚Üê Volver a Cafeter√≠as
      </button>

      <div class="mobile-date-header">
        <button class="icon-btn" onclick="app.changeMobileDate(-1)" style="width: 48px; height: 48px; font-size: 20px;">‚Üê</button>
        <div style="flex: 1; text-align: center;">
          <div class="mobile-date-title" id="mobileDateTitle">Mi√©rcoles 28 Enero</div>
          <input type="date" id="mobileDatePicker" onchange="app.updateMobileDate()" style="padding: 12px; font-size: 16px; border: 2px solid var(--border); border-radius: 10px; width: 100%; margin-top: 8px; min-height: 52px;">
        </div>
        <button class="icon-btn" onclick="app.changeMobileDate(1)" style="width: 48px; height: 48px; font-size: 20px;">‚Üí</button>
      </div>

      <div class="mobile-cafe-name" id="mobileCafeName" style="text-align: center; font-size: 18px; font-weight: 700; color: var(--text); margin: 16px 0; padding: 12px; background: var(--surface); border-radius: 10px;">Cafeter√≠a</div>

      <div class="mobile-products-list" id="mobileProductsList">
        <!-- Los productos se cargar√°n din√°micamente aqu√≠ -->
      </div>

      <div class="mobile-sync-indicator" id="mobileSyncIndicator">
        <span>‚úì</span>
        <span>Sincronizado</span>
      </div>
    </div>

    <!-- View: Tablet - Solo Lectura -->
    <div id="tabletReadonlyView" class="view tablet-readonly-view">
      <button class="back-button" onclick="app.showView('clientsView')">
        ‚Üê Volver a Cafeter√≠as
      </button>

      <div class="tablet-readonly-indicator">
        <span class="auto-refresh-indicator">
          <span class="spinner">üîÑ</span>
          <span>Modo solo lectura ¬∑ Actualizando autom√°ticamente</span>
        </span>
      </div>

      <div class="view-header">
        <div>
          <h2 class="view-title" id="tabletClientName">Cliente</h2>
          <div style="display: flex; align-items: center; gap: 12px; margin-top: 12px; flex-wrap: wrap;">
            <button class="icon-btn" onclick="app.changeTabletWeek(-1)" style="width: 40px; height: 40px; font-size: 18px;" title="Semana anterior">‚Üê</button>
            <div class="week-selector-badge" id="tabletWeekRange" onclick="app.resetTabletToCurrentWeek()" style="cursor: pointer; padding: 10px 16px; background: var(--surface); border: 2px solid var(--border); border-radius: 10px; font-size: 14px; font-weight: 600;">
              Cargando...
            </div>
            <button class="icon-btn" onclick="app.changeTabletWeek(1)" style="width: 40px; height: 40px; font-size: 18px;" title="Semana siguiente">‚Üí</button>
            <button class="btn-secondary" onclick="app.downloadTabletPNG()" style="padding: 10px 16px; min-height: 40px; font-size: 14px;">üì• Descargar PNG</button>
          </div>
          <!-- Inputs ocultos para compatibilidad con el c√≥digo existente -->
          <input type="date" id="tabletStartDate" style="display: none;">
          <input type="date" id="tabletEndDate" style="display: none;">
        </div>
      </div>

      <div class="stats-row" style="margin-bottom: 24px;">
        <div class="stat-card">
          <div class="stat-label">Total Bruto</div>
          <div class="stat-value" id="tabletGrossTotal">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Regresados</div>
          <div class="stat-value" id="tabletReturnsTotal">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Neto</div>
          <div class="stat-value" id="tabletNetTotal">$0.00</div>
        </div>
      </div>

      <div class="table-container">
        <table id="tabletOrdersTable">
          <thead id="tabletOrdersTableHead"></thead>
          <tbody id="tabletOrdersTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  </div>

  </div> <!-- cierre main-wrapper -->

  <!-- Modal: Cliente Form -->
  <div id="clientModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="clientModalTitle">Nueva Cafeter√≠a</h2>
        <button class="icon-btn" onclick="app.closeModal('clientModal')">‚úï</button>
      </div>
      
      <form id="clientForm">
        <div class="form-group">
          <label class="form-label">Nombre de la cafeter√≠a</label>
          <input type="text" class="form-input" id="clientName" placeholder="Ej. Cafeter√≠a Centro" required>
        </div>

        <div class="form-group">
          <label class="form-label">Color de identificaci√≥n</label>
          <input type="color" class="form-input" id="clientColor" value="#5ac8fa" style="height: 60px; cursor: pointer;">
        </div>

        <div class="form-group">
          <label class="form-label">Rango de semana</label>
          <select id="weekRange" class="form-input" style="cursor: pointer;">
            <option value="mon-sat">Lunes a S√°bado</option>
            <option value="tue-mon">Martes a Lunes</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Permitir regresados (Croissant y Chocolat√≠n)</label>
          <select id="allowReturns" class="form-input">
            <option value="false">No</option>
            <option value="true">S√≠</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Productos</label>
          <div id="productsList" class="product-list"></div>
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <input type="text" class="form-input" id="productName" placeholder="Nombre del producto" style="flex: 2;">
            <input type="number" class="form-input" id="productPrice" placeholder="Precio" step="0.01" style="flex: 1;">
            <button type="button" class="btn-primary" onclick="app.addProduct()">‚ûï</button>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="app.closeModal('clientModal')">Cancelar</button>
          <button type="submit" class="btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Import CSV -->
  <div id="importModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>Importar desde CSV</h2>
        <button class="icon-btn" onclick="app.closeModal('importModal')">‚úï</button>
      </div>
      
      <div class="form-group">
        <label class="form-label">Archivo CSV</label>
        <input type="file" id="csvFile" accept=".csv" class="form-input">
      </div>

      <div class="text-secondary mb-16" style="font-size: 13px;">
        <strong>Formato esperado:</strong> cafeteria, producto, precio, regresados, rango
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" onclick="app.closeModal('importModal')">Cancelar</button>
        <button class="btn-primary" onclick="app.importCSV()">Importar</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ============================================
    // CONFIGURACI√ìN DE SUPABASE
    // ============================================
    const SUPABASE_URL = 'https://bjuduoggpnvwjuqqbwuz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqdWR1b2dncG52d2p1cXFid3V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwOTg5MDcsImV4cCI6MjA4NDY3NDkwN30.tCtLbpj4e3KvsB3uPbg3uQiZRPpOLlswiDtWwlsZUXE';
    
    // Inicializar cliente de Supabase
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ============================================
    // DETECCI√ìN DE MODO (LOCAL vs SUPABASE)
    // ============================================
    const USE_SUPABASE = SUPABASE_URL !== 'TU_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'TU_SUPABASE_ANON_KEY';
    
    if (USE_SUPABASE) {
      console.log('‚úÖ Modo SUPABASE activado');
    } else {
      console.log('‚ö†Ô∏è Modo LOCAL (localStorage) - Configura Supabase para sincronizaci√≥n');
    }
    // Detectar tipo de dispositivo
    const DeviceDetector = {
      isMobile() {
        const userAgent = navigator.userAgent.toLowerCase();
        const maxWidth = window.innerWidth;
        // Considera m√≥vil si el ancho es menor a 768px o es un iPhone
        return maxWidth < 768 || /iphone/.test(userAgent);
      },
      isTablet() {
        const userAgent = navigator.userAgent.toLowerCase();
        const maxWidth = window.innerWidth;
        // Considera tablet si el ancho es entre 768px y 1024px o es un iPad
        return (maxWidth >= 768 && maxWidth <= 1024) || /ipad/.test(userAgent);
      },
      getDeviceType() {
        if (this.isMobile()) return 'mobile';
        if (this.isTablet()) return 'tablet';
        return 'desktop';
      }
    };

    // ============================================
    // SUPABASE STORE - Gesti√≥n de datos
    // ============================================
    class SupabaseStore {
      constructor() {
        this.storageKey = 'panfitrion_v2';
        this.useSupabase = USE_SUPABASE;
        this.data = { clients: [], globalDateRange: {} };
        this.clientsCache = [];
      }

      async testConnection() {
        if (!this.useSupabase) {
          return false;
        }

        try {
          // Hacer una consulta simple para verificar conexi√≥n
          const { error } = await supabaseClient
            .from('cafeterias')
            .select('id')
            .limit(1);

          if (error) {
            console.error('‚ùå Error de conexi√≥n:', error);
            return false;
          }

          return true;
        } catch (error) {
          console.error('‚ùå No se puede conectar a Supabase:', error);
          return false;
        }
      }

      // ============================================
      // M√âTODOS DE CAFETER√çAS
      // ============================================
      
      async getClients() {
        if (!this.useSupabase) {
          console.log('‚ö†Ô∏è Usando localStorage (modo offline)');
          return this.loadLocalClients();
        }

        try {
          // Probar conexi√≥n primero
          const { data: cafeterias, error } = await supabaseClient
            .from('cafeterias')
            .select(`
              *,
              productos (*)
            `)
            .order('created_at', { ascending: true });

          if (error) {
            console.error('‚ùå Error de Supabase:', error);
            throw error;
          }

          if (!cafeterias) {
            console.log('‚ÑπÔ∏è No hay cafeter√≠as en Supabase, usando localStorage');
            return this.loadLocalClients();
          }

          // Transformar estructura de Supabase a formato de la app
          this.clientsCache = cafeterias.map(cafe => ({
            id: cafe.id,
            name: cafe.nombre,
            color: cafe.color || '#5ac8fa',
            weekRange: cafe.rango_semana,
            allowReturns: cafe.permite_regresados,
            products: cafe.productos.map(p => ({
              id: p.id,
              name: p.nombre,
              price: p.precio
            })),
            currentWeek: null,
            history: []
          }));

          console.log(`‚úÖ ${this.clientsCache.length} cafeter√≠as cargadas desde Supabase`);
          return this.clientsCache;
        } catch (error) {
          console.error('‚ùå Error al cargar cafeter√≠as:', error);
          
          // Si hay error de red o CORS, usar localStorage
          if (error.message && (error.message.includes('Failed') || error.message.includes('Load failed'))) {
            console.log('‚ö†Ô∏è Problema de conexi√≥n, usando datos locales');
            alert('‚ö†Ô∏è No se pudo conectar a Supabase.\n\nUsando datos guardados localmente.\n\nVerifica tu conexi√≥n a internet.');
          }
          
          return this.loadLocalClients();
        }
      }

      async addClient(client) {
        if (!this.useSupabase) {
          return this.addLocalClient(client);
        }

        try {
          // 1. Crear cafeter√≠a (sin color primero, para compatibilidad)
          const cafeData = {
            nombre: client.name,
            rango_semana: client.weekRange,
            permite_regresados: client.allowReturns
          };
          
          // Intentar agregar color si la columna existe
          try {
            cafeData.color = client.color || '#5ac8fa';
          } catch (e) {
            console.log('‚ÑπÔ∏è Columna color no disponible, continuando sin ella');
          }

          const { data: cafeteria, error: cafeError } = await supabaseClient
            .from('cafeterias')
            .insert(cafeData)
            .select()
            .single();

          if (cafeError) throw cafeError;

          // 2. Crear productos
          if (client.products.length > 0) {
            const productos = client.products.map(p => ({
              cafeteria_id: cafeteria.id,
              nombre: p.name,
              precio: p.price
            }));

            const { error: prodError } = await supabaseClient
              .from('productos')
              .insert(productos);

            if (prodError) throw prodError;
          }

          console.log('‚úÖ Cafeter√≠a creada en Supabase:', cafeteria);
          return cafeteria.id;
        } catch (error) {
          console.error('Error al crear cafeter√≠a:', error);
          
          // Si el error es por la columna color, reintentar sin ella
          if (error.code === 'PGRST204' && error.message.includes('color')) {
            console.log('‚ö†Ô∏è Reintentando sin columna color...');
            return this.addClientWithoutColor(client);
          }
          
          alert('‚ö†Ô∏è Error al crear cafeter√≠a: ' + error.message);
          return this.addLocalClient(client);
        }
      }

      async addClientWithoutColor(client) {
        try {
          const { data: cafeteria, error: cafeError } = await supabaseClient
            .from('cafeterias')
            .insert({
              nombre: client.name,
              rango_semana: client.weekRange,
              permite_regresados: client.allowReturns
            })
            .select()
            .single();

          if (cafeError) throw cafeError;

          if (client.products.length > 0) {
            const productos = client.products.map(p => ({
              cafeteria_id: cafeteria.id,
              nombre: p.name,
              precio: p.price
            }));

            const { error: prodError } = await supabaseClient
              .from('productos')
              .insert(productos);

            if (prodError) throw prodError;
          }

          console.log('‚úÖ Cafeter√≠a creada (sin color):', cafeteria);
          return cafeteria.id;
        } catch (error) {
          console.error('Error al crear cafeter√≠a sin color:', error);
          throw error;
        }
      }

      async updateClient(index, client) {
        if (!this.useSupabase || !client.id) {
          return this.updateLocalClient(index, client);
        }

        try {
          const updateData = {
            nombre: client.name,
            permite_regresados: client.allowReturns
          };
          
          // Intentar actualizar color si existe
          try {
            updateData.color = client.color || '#5ac8fa';
          } catch (e) {
            // Columna no existe, continuar sin ella
          }

          const { error } = await supabaseClient
            .from('cafeterias')
            .update(updateData)
            .eq('id', client.id);

          if (error) {
            // Si falla por color, reintentar sin ella
            if (error.code === 'PGRST204' && error.message.includes('color')) {
              delete updateData.color;
              const { error: retryError } = await supabaseClient
                .from('cafeterias')
                .update(updateData)
                .eq('id', client.id);
              
              if (retryError) throw retryError;
            } else {
              throw error;
            }
          }

          console.log('‚úÖ Cafeter√≠a actualizada en Supabase');
        } catch (error) {
          console.error('Error al actualizar cafeter√≠a:', error);
          alert('‚ö†Ô∏è Error al actualizar cafeter√≠a: ' + error.message);
          this.updateLocalClient(index, client);
        }
      }

      async deleteClient(index) {
        const clients = await this.getClients();
        const client = clients[index];

        if (!this.useSupabase || !client.id) {
          return this.deleteLocalClient(index);
        }

        try {
          const { error } = await supabaseClient
            .from('cafeterias')
            .delete()
            .eq('id', client.id);

          if (error) throw error;
          console.log('‚úÖ Cafeter√≠a eliminada');
        } catch (error) {
          console.error('Error al eliminar cafeter√≠a:', error);
          this.deleteLocalClient(index);
        }
      }

      // ============================================
      // M√âTODOS DE PEDIDOS
      // ============================================

      async getOrders(cafeteriaId, startDate, endDate) {
        if (!this.useSupabase) return {};

        try {
          const { data, error } = await supabaseClient
            .from('pedidos')
            .select(`
              *,
              productos (id, nombre, precio)
            `)
            .eq('cafeteria_id', cafeteriaId)
            .gte('fecha', startDate)
            .lte('fecha', endDate);

          if (error) throw error;

          // Transformar a estructura de la app
          const orders = {};
          data.forEach(pedido => {
            const productName = pedido.productos.nombre;
            if (!orders[productName]) orders[productName] = {};
            orders[productName][pedido.fecha] = pedido.cantidad;
          });

          return orders;
        } catch (error) {
          console.error('Error al cargar pedidos:', error);
          return {};
        }
      }

      async setOrderQuantity(cafeteriaId, productoId, fecha, cantidad) {
        if (!this.useSupabase) return;

        try {
          const { error } = await supabaseClient
            .from('pedidos')
            .upsert({
              cafeteria_id: cafeteriaId,
              producto_id: productoId,
              fecha: fecha,
              cantidad: cantidad
            }, {
              onConflict: 'cafeteria_id,producto_id,fecha'
            });

          if (error) throw error;
        } catch (error) {
          console.error('Error al guardar pedido:', error);
        }
      }

      // ============================================
      // M√âTODOS DE REGRESADOS (DIARIOS)
      // ============================================

      async getReturns(cafeteriaId, startDate, endDate) {
        if (!this.useSupabase) return {};

        try {
          const { data, error } = await supabaseClient
            .from('regresados')
            .select(`
              *,
              productos (id, nombre, precio)
            `)
            .eq('cafeteria_id', cafeteriaId)
            .gte('fecha', startDate)
            .lte('fecha', endDate);

          if (error) throw error;

          // Transformar a estructura de la app
          const returns = {};
          data.forEach(regresado => {
            const productName = regresado.productos.nombre;
            if (!returns[productName]) returns[productName] = {};
            returns[productName][regresado.fecha] = regresado.cantidad;
          });

          return returns;
        } catch (error) {
          console.error('Error al cargar regresados:', error);
          return {};
        }
      }

      async setReturnQuantity(cafeteriaId, productoId, fecha, cantidad) {
        if (!this.useSupabase) return;

        try {
          const { error } = await supabaseClient
            .from('regresados')
            .upsert({
              cafeteria_id: cafeteriaId,
              producto_id: productoId,
              fecha: fecha,
              cantidad: cantidad
            }, {
              onConflict: 'cafeteria_id,producto_id,fecha'
            });

          if (error) throw error;
        } catch (error) {
          console.error('Error al guardar regresados:', error);
        }
      }

      // ============================================
      // M√âTODOS LOCALES (FALLBACK)
      // ============================================

      loadLocalClients() {
        try {
          const stored = localStorage.getItem(this.storageKey);
          const data = stored ? JSON.parse(stored) : { clients: [] };
          return data.clients || [];
        } catch (e) {
          return [];
        }
      }

      saveLocal() {
        localStorage.setItem(this.storageKey, JSON.stringify(this.data));
      }

      addLocalClient(client) {
        const data = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
        if (!data.clients) data.clients = [];
        data.clients.push(client);
        localStorage.setItem(this.storageKey, JSON.stringify(data));
      }

      updateLocalClient(index, client) {
        const data = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
        if (data.clients && data.clients[index]) {
          data.clients[index] = client;
          localStorage.setItem(this.storageKey, JSON.stringify(data));
        }
      }

      deleteLocalClient(index) {
        const data = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
        if (data.clients) {
          data.clients.splice(index, 1);
          localStorage.setItem(this.storageKey, JSON.stringify(data));
        }
      }
    }

    class OrderManager {
      static getWeekDays(range) {
        return range === 'tue-mon' 
          ? ['Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Lunes']
          : ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
      }

      static getWeekDates(range, weekOffset = 0) {
        const today = new Date();
        const d = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        
        // Ajustar por el offset de semanas
        d.setDate(d.getDate() + (weekOffset * 7));
        
        const day = d.getDay();
        
        let start, end;
        if (range === 'tue-mon') {
          const offset = day >= 2 ? day - 2 : 7 - (2 - day);
          start = new Date(d);
          start.setDate(d.getDate() - offset);
          end = new Date(start);
          end.setDate(start.getDate() + 6);
        } else {
          const offset = day >= 1 ? day - 1 : 6;
          start = new Date(d);
          start.setDate(d.getDate() - offset);
          end = new Date(start);
          end.setDate(start.getDate() + 5);
        }
        
        return { start, end };
      }

      static formatDate(date) {
        const months = ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'];
        const day = date.getDate();
        const month = months[date.getMonth()];
        return `${day} ${month}`;
      }

      static formatDateWithDay(date) {
        const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
        const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        const dayName = days[date.getDay()];
        const dayNum = date.getDate();
        const month = months[date.getMonth()];
        return `${dayName} ${dayNum} ${month}`;
      }

      static getWeekDatesArray(range, weekOffset = 0) {
        const { start } = this.getWeekDates(range, weekOffset);
        const dates = [];
        const numDays = range === 'tue-mon' ? 6 : 6;
        
        for (let i = 0; i <= numDays; i++) {
          const date = new Date(start);
          date.setDate(start.getDate() + i);
          dates.push(date);
        }
        
        return dates;
      }

      static initWeekStructure(client) {
        const { start, end } = this.getWeekDates(client.weekRange);
        const weekKey = `${this.formatDate(start)}_${this.formatDate(end)}`;
        
        if (!client.currentWeek || client.currentWeek.key !== weekKey) {
          client.currentWeek = {
            key: weekKey,
            start: this.formatDate(start),
            end: this.formatDate(end),
            data: {}
          };
        }

        const days = this.getWeekDays(client.weekRange);
        client.products.forEach(product => {
          if (!client.currentWeek.data[product.name]) {
            client.currentWeek.data[product.name] = { weeklyReturned: 0 };
          }
          days.forEach(day => {
            if (!client.currentWeek.data[product.name][day]) {
              client.currentWeek.data[product.name][day] = 0;
            }
          });
        });

        return client;
      }

      static calculateTotals(client) {
        const days = this.getWeekDays(client.weekRange);
        let gross = 0;
        let returns = 0;

        client.products.forEach(product => {
          days.forEach(day => {
            const qty = client.currentWeek.data[product.name][day] || 0;
            gross += qty * product.price;
          });

          const isReturnable = client.allowReturns && 
            (product.name.toLowerCase() === 'croissant' || 
             product.name.toLowerCase() === 'chocolat√≠n');
          
          if (isReturnable) {
            const returnsData = client.currentWeek.data[product.name].returns || {};
            days.forEach(day => {
              const returnQty = returnsData[day] || 0;
              returns += returnQty * product.price;
            });
          }
        });

        return {
          gross,
          returns,
          net: Math.max(0, gross - returns)
        };
      }
    }

    class App {
      constructor() {
        this.store = new SupabaseStore();
        this.tempProducts = [];
        this.editingClientIndex = null;
        this.currentClientIndex = null;
        this.currentClient = null;
        this.currentOrders = {};
        this.currentReturns = {};
        this.weekOffset = 0; // Offset de semanas (0 = semana actual, -1 = semana anterior, +1 = siguiente)
        this.dashboardWeekOffset = 0; // Offset de semanas para dashboard (siempre Lunes-S√°bado)
        this.init();
      }

      async init() {
        await this.renderClients();
        await this.renderMobileCafesList();
        this.setupEventListeners();
        this.showView('clientsView');
        this.updateConnectionStatus();
        
        // Inicializar y cargar dashboard
        await this.loadDashboardData();
      }

      updateConnectionStatus() {
        const status = document.getElementById('connectionStatus');
        if (USE_SUPABASE) {
          status.textContent = '‚úÖ Supabase';
          status.style.background = 'rgba(52, 199, 89, 0.1)';
          status.style.color = 'var(--success)';
        } else {
          status.textContent = 'üíæ Local';
          status.style.background = 'rgba(255, 149, 0, 0.1)';
          status.style.color = 'var(--warning)';
        }
      }

      showView(viewId) {
        // Detener actualizaci√≥n autom√°tica de tablet si se cambia de vista
        if (this.tabletRefreshInterval) {
          clearInterval(this.tabletRefreshInterval);
          this.tabletRefreshInterval = null;
        }

        document.querySelectorAll('.view').forEach(view => {
          view.classList.remove('active');
        });
        document.getElementById(viewId).classList.add('active');
        window.scrollTo(0, 0);
        
        // Ocultar header si no estamos en clientsView (dashboard)
        const header = document.querySelector('header');
        if (viewId === 'clientsView') {
          header.classList.remove('hidden');
        } else {
          header.classList.add('hidden');
        }
      }

      async showDashboard() {
        this.showView('clientsView');
        await this.loadDashboardData();
      }

      async changeDashboardWeek(direction) {
        this.dashboardWeekOffset += direction;
        await this.loadDashboardData();
      }

      async resetDashboardWeek() {
        this.dashboardWeekOffset = 0;
        await this.loadDashboardData();
      }

      async loadDashboardData() {
        // Usar weekOffset con rango Lunes-S√°bado
        const { start, end } = OrderManager.getWeekDates('mon-sat', this.dashboardWeekOffset);
        const startDate = this.formatDateForDB(start);
        const endDate = this.formatDateForDB(end);
        
        // Actualizar badge
        document.getElementById('dashboardWeekRange').textContent = 
          `${OrderManager.formatDate(start)} - ${OrderManager.formatDate(end)}`;
        
        if (this.dashboardWeekOffset !== 0) {
          const weekText = this.dashboardWeekOffset < 0 ? `${Math.abs(this.dashboardWeekOffset)} sem. atr√°s` : `${this.dashboardWeekOffset} sem. adelante`;
          document.getElementById('dashboardWeekRange').textContent += ` (${weekText})`;
        }

        const clients = await this.store.getClients();
        const grid = document.getElementById('dashboardGrid');
        
        if (clients.length === 0) {
          grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); padding: 40px;">No hay cafeter√≠as registradas</p>';
          return;
        }

        const productoStats = {};

        // Primero, inicializar todos los productos de todas las cafeter√≠as con 0
        for (const client of clients) {
          client.products.forEach(product => {
            // Normalizar nombre de producto
            const normalizedName = product.name.toLowerCase()
              .replace(/almenra/g, 'almendra')
              .replace(/hogaza\s*multigrano/gi, 'hogaza multigrano')
              .replace(/demibaguette/gi, 'demi baguette')
              .replace(/demi-baguette/gi, 'demi baguette')
              .replace(/ciabattta/gi, 'ciabatta')
              .replace(/croissanr/gi, 'croissant')
              .replace(/\s+/g, ' ')
              .trim();
            
            console.log(`Producto original: "${product.name}" -> normalizado: "${normalizedName}"`);
            
            // Para ciertos productos, mantener separado por cafeter√≠a
            const productosPorCafeteria = ['ciabatta', 'focaccia'];
            const key = productosPorCafeteria.includes(normalizedName) 
              ? `${normalizedName}|${client.name}` 
              : normalizedName;
            
            if (!productoStats[key]) {
              productoStats[key] = {
                nombre: normalizedName.charAt(0).toUpperCase() + normalizedName.slice(1),
                cafeteria: productosPorCafeteria.includes(normalizedName) ? client.name : null,
                vendidos: 0
              };
            }
          });
        }

        // Luego, sumar los vendidos
        for (const client of clients) {
          const orders = await this.store.getOrders(client.id, startDate, endDate) || {};

          console.log(`Dashboard - ${client.name}:`, {
            startDate,
            endDate,
            orders
          });

          // Contar vendidos (orders es un objeto: {productName: {fecha: cantidad}})
          Object.keys(orders).forEach(productName => {
            // Normalizar nombre de producto
            const normalizedName = productName.toLowerCase()
              .replace(/almenra/g, 'almendra')
              .replace(/hogaza\s+multigrano/g, 'hogaza multigrano')
              .replace(/demibaguette/g, 'demi baguette')
              .replace(/demi-baguette/g, 'demi baguette')
              .replace(/ciabattta/gi, 'ciabatta')
              .replace(/croissanr/gi, 'croissant')
              .replace(/\s+/g, ' ')
              .trim();
            
            const productosPorCafeteria = ['ciabatta', 'focaccia'];
            const key = productosPorCafeteria.includes(normalizedName) 
              ? `${normalizedName}|${client.name}` 
              : normalizedName;
            
            const dates = orders[productName];
            Object.keys(dates).forEach(fecha => {
              const cantidad = parseInt(dates[fecha]) || 0;
              
              if (productoStats[key]) {
                productoStats[key].vendidos += cantidad;
              }
              
              console.log(`  ${productName} en ${fecha}: +${cantidad} (total: ${productoStats[key]?.vendidos || 0})`);
            });
          });
        }

        console.log('Stats finales:', productoStats);
        console.log('Keys en productoStats:', Object.keys(productoStats));

        // Definir grupos de productos
        const grupos = [
          {
            nombre: 'Viennoiserie',
            productos: ['croissant', 'chocolat√≠n']
          },
          {
            nombre: 'Panes',
            productos: ['baguette', 'demi baguette', 'hogaza', 'hogaza multigrano']
          },
          {
            nombre: 'Panes Especiales',
            productos: ['focaccia', 'ciabatta']
          },
          {
            nombre: 'Cajas y Bollos',
            productos: ['caja blanco', 'caja multigrano', 'brioche', 'bollo']
          }
        ];

        // Renderizar tarjetas por producto agrupadas
        let html = '';
        const productosUsados = new Set();

        // Renderizar cada grupo
        grupos.forEach(grupo => {
          // Verificar si hay productos en este grupo (considerando variantes con |cafeteria)
          const productosDelGrupo = grupo.productos.filter(prodKey => {
            return Object.keys(productoStats).some(key => key.split('|')[0] === prodKey);
          });
          
          if (productosDelGrupo.length > 0) {
            html += `
              <div style="grid-column: 1/-1; margin-top: 24px; margin-bottom: 12px;">
                <div style="border-bottom: 2px solid var(--border);"></div>
              </div>
            `;
            
            grupo.productos.forEach(prodKey => {
              // Buscar productos que coincidan (pueden tener |cafeteria)
              const matchingKeys = Object.keys(productoStats).filter(key => {
                const baseName = key.split('|')[0];
                const normalizedBase = baseName.toLowerCase().trim();
                const normalizedSearch = prodKey.toLowerCase().trim();
                return normalizedBase === normalizedSearch;
              });
              
              console.log(`Grupo ${grupo.nombre}, buscando "${prodKey}", encontrados:`, matchingKeys);
              
              matchingKeys.forEach(key => {
                const stat = productoStats[key];
                productosUsados.add(key);
                
                console.log(`  Marcando como usado: "${key}"`);
                
                html += `
                  <div class="dashboard-card">
                    <div class="dashboard-card-title">${stat.nombre}</div>
                    ${stat.cafeteria ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${stat.cafeteria}</div>` : ''}
                    <div class="dashboard-card-value">${stat.vendidos}</div>
                  </div>
                `;
              });
            });
          }
        });

        // Renderizar productos restantes (otros)
        const productosRestantes = Object.keys(productoStats)
          .filter(p => !productosUsados.has(p))
          .sort();

        console.log('Productos usados:', Array.from(productosUsados));
        console.log('Productos restantes:', productosRestantes);

        if (productosRestantes.length > 0) {
          html += `
            <div style="grid-column: 1/-1; margin-top: 24px; margin-bottom: 12px;">
              <div style="border-bottom: 2px solid var(--border);"></div>
            </div>
          `;
          
          productosRestantes.forEach(prodKey => {
            const stat = productoStats[prodKey];
            
            html += `
              <div class="dashboard-card">
                <div class="dashboard-card-title">${stat.nombre}</div>
                ${stat.cafeteria ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${stat.cafeteria}</div>` : ''}
                <div class="dashboard-card-value">${stat.vendidos}</div>
              </div>
            `;
          });
        }

        if (html === '') {
          html = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); padding: 40px;">No hay datos en el rango seleccionado</p>';
        }

        grid.innerHTML = html;
      }

      setupEventListeners() {
        document.getElementById('clientForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.saveClient();
        });
      }

      getContrastColor(hexColor) {
        // Convertir hex a RGB
        const hex = hexColor.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        
        // Calcular luminancia
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        
        // Retornar blanco o negro seg√∫n luminancia
        return luminance > 0.5 ? '#1d1d1f' : '#ffffff';
      }

      async renderClients() {
        const clients = await this.store.getClients();
        const sidebar = document.getElementById('sidebarCafes');
        const empty = document.getElementById('emptyState');

        // Mantener el header del sidebar y el bot√≥n de inicio
        const header = sidebar.querySelector('.sidebar-header');
        const homeButton = sidebar.querySelector('button[onclick="app.showDashboard()"]');

        if (clients.length === 0) {
          sidebar.innerHTML = '';
          if (header) sidebar.appendChild(header);
          if (homeButton) sidebar.appendChild(homeButton);
          sidebar.innerHTML += `
            <button class="add-cafe-btn" onclick="app.showClientModal()">
              ‚ûï Nueva Cafeter√≠a
            </button>
          `;
          if (empty) empty.classList.remove('hidden');
          return;
        }

        if (empty) empty.classList.add('hidden');
        
        let html = '';
        if (header) html = header.outerHTML;
        if (homeButton) html += homeButton.outerHTML;
        
        html += clients.map((client, index) => {
          const bgColor = client.color || '#5ac8fa';
          const textColor = this.getContrastColor(bgColor);
          return `
            <button class="cafe-button" style="background: ${bgColor}; color: ${textColor};" onclick="app.openOrders(${index})">
              <span>${client.name}</span>
            </button>
          `;
        }).join('');
        
        html += `
          <button class="add-cafe-btn" onclick="app.showClientModal()">
            ‚ûï Nueva Cafeter√≠a
          </button>
        `;
        
        sidebar.innerHTML = html;
        
        // Actualizar el men√∫ m√≥vil tambi√©n
        await this.renderMobileCafesList();
      }

      async showClientModal(editIndex = null) {
        this.editingClientIndex = editIndex;
        this.tempProducts = [];

        if (editIndex !== null) {
          // MODO EDICI√ìN
          const clients = await this.store.getClients();
          const client = clients[editIndex];
          document.getElementById('clientModalTitle').textContent = 'Editar Cafeter√≠a';
          document.getElementById('clientName').value = client.name;
          document.getElementById('clientColor').value = client.color || '#5ac8fa';
          document.getElementById('weekRange').value = client.weekRange;
          document.getElementById('weekRange').disabled = true;
          document.getElementById('weekRange').style.opacity = '0.6';
          document.getElementById('weekRange').style.cursor = 'not-allowed';
          document.getElementById('allowReturns').value = client.allowReturns ? 'true' : 'false';
          this.tempProducts = [...client.products];
        } else {
          // MODO CREACI√ìN
          document.getElementById('clientModalTitle').textContent = 'Nueva Cafeter√≠a';
          document.getElementById('clientName').value = '';
          document.getElementById('clientColor').value = '#5ac8fa';
          document.getElementById('weekRange').value = 'mon-sat';
          document.getElementById('weekRange').disabled = false;
          document.getElementById('weekRange').style.opacity = '1';
          document.getElementById('weekRange').style.cursor = 'pointer';
          document.getElementById('allowReturns').value = 'false';
          document.getElementById('productName').value = '';
          document.getElementById('productPrice').value = '';
          this.tempProducts = [];
        }

        this.renderProductsList();
        this.openModal('clientModal');
      }

      editClient(index) {
        this.showClientModal(index);
      }

      async deleteClient(index) {
        const clients = await this.store.getClients();
        const client = clients[index];
        if (confirm(`¬øEliminar "${client.name}"? Esta acci√≥n no se puede deshacer.`)) {
          await this.store.deleteClient(index);
          await this.renderClients();
        }
      }

      addProduct() {
        const name = document.getElementById('productName').value.trim();
        const price = parseFloat(document.getElementById('productPrice').value);

        if (!name || !price || price < 0) {
          alert('Ingresa nombre y precio v√°lido');
          return;
        }

        this.tempProducts.push({ name, price });
        document.getElementById('productName').value = '';
        document.getElementById('productPrice').value = '';
        this.renderProductsList();
      }

      removeProduct(index) {
        this.tempProducts.splice(index, 1);
        this.renderProductsList();
      }

      renderProductsList() {
        const container = document.getElementById('productsList');
        
        if (this.tempProducts.length === 0) {
          container.innerHTML = '<div class="text-secondary text-center">Sin productos</div>';
          return;
        }

        container.innerHTML = this.tempProducts.map((product, index) => `
          <div class="product-item">
            <div class="product-name">${product.name}</div>
            <div class="product-price">$${product.price.toFixed(2)}</div>
            <button class="icon-btn" onclick="app.removeProduct(${index})">üóëÔ∏è</button>
          </div>
        `).join('');
      }

      async saveClient() {
        const name = document.getElementById('clientName').value.trim();
        const color = document.getElementById('clientColor').value;
        const weekRange = document.getElementById('weekRange').value;
        const allowReturns = document.getElementById('allowReturns').value === 'true';

        if (!name || this.tempProducts.length === 0) {
          alert('Completa todos los campos y agrega al menos un producto');
          return;
        }

        const client = {
          name,
          color,
          weekRange,
          allowReturns,
          products: this.tempProducts,
          currentWeek: null,
          history: []
        };

        if (this.editingClientIndex !== null) {
          const clients = await this.store.getClients();
          const existing = clients[this.editingClientIndex];
          client.id = existing.id;
          client.currentWeek = existing.currentWeek;
          client.history = existing.history || [];
          client.weekRange = existing.weekRange;
          await this.store.updateClient(this.editingClientIndex, client);
        } else {
          await this.store.addClient(client);
        }

        this.closeModal('clientModal');
        await this.renderClients();
      }

      async changeWeek(direction) {
        this.weekOffset += direction;
        await this.openOrders(this.currentClientIndex);
      }

      resetToCurrentWeek() {
        this.weekOffset = 0;
        this.openOrders(this.currentClientIndex);
      }

      async openOrders(index) {
        this.currentClientIndex = index;
        const clients = await this.store.getClients();
        let client = clients[index];
        this.currentClient = client;
        
        // Si es la primera vez que abrimos esta cafeter√≠a, resetear offset
        if (this.currentClientIndex !== index) {
          this.weekOffset = 0;
        }
        
        // Inicializar estructura de semana
        client = OrderManager.initWeekStructure(client);
        
        // Cargar pedidos y regresados de Supabase si est√° disponible
        if (USE_SUPABASE && client.id) {
          const { start, end } = OrderManager.getWeekDates(client.weekRange, this.weekOffset);
          const startStr = start.toISOString().split('T')[0];
          const endStr = end.toISOString().split('T')[0];
          
          this.currentOrders = await this.store.getOrders(client.id, startStr, endStr);
          this.currentReturns = await this.store.getReturns(client.id, startStr, endStr);
          
          // Merge datos de Supabase con estructura local
          this.mergeSupabaseData(client);
        }

        // Detectar tipo de dispositivo y mostrar vista apropiada
        const deviceType = DeviceDetector.getDeviceType();
        
        if (deviceType === 'mobile') {
          this.openMobileOrderView(index, client);
        } else if (deviceType === 'tablet') {
          this.openTabletReadonlyView(index, client);
        } else {
          this.openDesktopOrderView(index, client);
        }
      }

      mergeSupabaseData(client) {
        // Asegurar que la estructura existe
        if (!client.currentWeek) {
          client.currentWeek = { data: {} };
        }
        if (!client.currentWeek.data) {
          client.currentWeek.data = {};
        }

        // Inicializar estructura para todos los productos
        const days = OrderManager.getWeekDays(client.weekRange);
        client.products.forEach(product => {
          if (!client.currentWeek.data[product.name]) {
            client.currentWeek.data[product.name] = {};
          }
          // Inicializar todos los d√≠as en 0
          days.forEach(day => {
            if (!client.currentWeek.data[product.name][day]) {
              client.currentWeek.data[product.name][day] = 0;
            }
          });
          // Inicializar returns
          if (!client.currentWeek.data[product.name].returns) {
            client.currentWeek.data[product.name].returns = {};
          }
        });

        // Merge pedidos desde Supabase
        Object.keys(this.currentOrders).forEach(productName => {
          if (!client.currentWeek.data[productName]) {
            client.currentWeek.data[productName] = {};
          }
          Object.keys(this.currentOrders[productName]).forEach(fecha => {
            const day = this.convertDateToDay(fecha, client.weekRange);
            if (day) {
              client.currentWeek.data[productName][day] = this.currentOrders[productName][fecha];
            }
          });
        });

        // Merge regresados desde Supabase
        Object.keys(this.currentReturns).forEach(productName => {
          if (!client.currentWeek.data[productName]) {
            client.currentWeek.data[productName] = {};
          }
          if (!client.currentWeek.data[productName].returns) {
            client.currentWeek.data[productName].returns = {};
          }
          Object.keys(this.currentReturns[productName]).forEach(fecha => {
            const day = this.convertDateToDay(fecha, client.weekRange);
            if (day) {
              client.currentWeek.data[productName].returns[day] = this.currentReturns[productName][fecha];
            }
          });
        });
      }

      convertDateToDay(fecha, weekRange) {
        const date = new Date(fecha + 'T00:00:00');
        const dayOfWeek = date.getDay();
        const days = OrderManager.getWeekDays(weekRange);
        
        if (weekRange === 'tue-mon') {
          const map = { 2: 0, 3: 1, 4: 2, 5: 3, 6: 4, 1: 5 };
          return days[map[dayOfWeek]];
        } else {
          const map = { 1: 0, 2: 1, 3: 2, 4: 3, 5: 4, 6: 5 };
          return days[map[dayOfWeek]];
        }
      }

      convertDayToDate(day, weekRange) {
        const { start } = OrderManager.getWeekDates(weekRange, this.weekOffset);
        const days = OrderManager.getWeekDays(weekRange);
        const dayIndex = days.indexOf(day);
        
        if (dayIndex === -1) return null;
        
        const date = new Date(start);
        date.setDate(start.getDate() + dayIndex);
        return date.toISOString().split('T')[0];
      }

      formatDateForDB(date) {
        return date.toISOString().split('T')[0];
      }

      async openMobileOrderView(index, client) {
        this.currentClientIndex = index;
        this.showView('mobileOrderView');
        
        // Configurar fecha actual
        const today = new Date();
        document.getElementById('mobileDatePicker').value = today.toISOString().split('T')[0];
        document.getElementById('mobileCafeName').textContent = client.name;
        
        await this.renderMobileProducts();
      }

      async updateMobileDate() {
        await this.renderMobileProducts();
      }

      async changeMobileDate(direction) {
        const currentDate = new Date(document.getElementById('mobileDatePicker').value);
        currentDate.setDate(currentDate.getDate() + direction);
        document.getElementById('mobileDatePicker').value = currentDate.toISOString().split('T')[0];
        await this.renderMobileProducts();
      }

      async renderMobileProducts() {
        const clients = await this.store.getClients();
        const client = clients[this.currentClientIndex];
        const selectedDate = document.getElementById('mobileDatePicker').value;
        
        if (!selectedDate) return;
        
        // Actualizar t√≠tulo con formato legible
        const dateObj = new Date(selectedDate + 'T00:00:00');
        const options = { weekday: 'long', day: 'numeric', month: 'long' };
        const dateStr = dateObj.toLocaleDateString('es-ES', options);
        document.getElementById('mobileDateTitle').textContent = 
          dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

        // Obtener pedidos del d√≠a seleccionado
        const orders = await this.store.getOrders(client.id, selectedDate, selectedDate);
        const returns = await this.store.getReturns(client.id, selectedDate, selectedDate);

        // Renderizar lista de productos con inputs
        const container = document.getElementById('mobileProductsList');
        container.innerHTML = client.products.map((product, idx) => {
          const orderQty = (orders[product.name] && orders[product.name][selectedDate]) || 0;
          const returnQty = (returns[product.name] && returns[product.name][selectedDate]) || 0;
          
          return `
            <div class="mobile-product-item" style="background: var(--surface); padding: 20px; border-radius: 12px; margin-bottom: 12px; box-shadow: var(--shadow);">
              <div class="mobile-product-name" style="font-size: 18px; font-weight: 700; margin-bottom: 12px; color: var(--text);">${product.name}</div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div style="flex: 1;">
                  <label style="font-size: 13px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">Pedido</label>
                  <input type="number" 
                         class="qty-input" 
                         value="${orderQty}" 
                         onchange="app.updateMobileOrder('${product.id}', '${selectedDate}', this.value, 'order')"
                         style="width: 100%; min-height: 70px; font-size: 28px; text-align: center; padding: 16px; border: 3px solid var(--border); border-radius: 12px;">
                </div>
                ${client.allowReturns && (product.name === 'Croissant' || product.name === 'Chocolat√≠n') ? `
                <div style="flex: 1;">
                  <label style="font-size: 13px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">‚Ü©Ô∏è Regresado</label>
                  <input type="number" 
                         class="qty-input" 
                         value="${returnQty}" 
                         onchange="app.updateMobileOrder('${product.id}', '${selectedDate}', this.value, 'return')"
                         style="width: 100%; min-height: 70px; font-size: 28px; text-align: center; padding: 16px; border: 3px solid var(--danger); border-radius: 12px;">
                </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      async updateMobileOrder(productId, fecha, cantidad, type) {
        const clients = await this.store.getClients();
        const client = clients[this.currentClientIndex];
        const qty = parseInt(cantidad) || 0;
        
        if (type === 'order') {
          await this.store.setOrderQuantity(client.id, productId, fecha, qty);
        } else if (type === 'return') {
          await this.store.setReturnQuantity(client.id, productId, fecha, qty);
        }
        
        this.showSyncIndicator();
      }

      showSyncIndicator() {
        const indicator = document.getElementById('mobileSyncIndicator');
        indicator.classList.add('show');
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 2000);
      }

      async openTabletReadonlyView(index, client) {
        this.currentClientIndex = index;
        this.showView('tabletReadonlyView');
        
        document.getElementById('tabletClientName').textContent = client.name;
        
        // Usar weekOffset para fechas coherentes con el rango de la cafeter√≠a
        const { start, end } = OrderManager.getWeekDates(client.weekRange, this.weekOffset);
        const startDate = this.formatDateForDB(start);
        const endDate = this.formatDateForDB(end);
        
        document.getElementById('tabletStartDate').value = startDate;
        document.getElementById('tabletEndDate').value = endDate;
        
        // Actualizar badge de semana
        document.getElementById('tabletWeekRange').textContent = 
          `${OrderManager.formatDate(start)} - ${OrderManager.formatDate(end)}`;
        
        if (this.weekOffset !== 0) {
          const weekText = this.weekOffset < 0 ? `${Math.abs(this.weekOffset)} sem. atr√°s` : `${this.weekOffset} sem. adelante`;
          document.getElementById('tabletWeekRange').textContent += ` (${weekText})`;
        }

        await this.renderTabletTable(client);
        await this.updateTabletTotals(client);

        // Auto-actualizar cada 3 segundos
        if (this.tabletRefreshInterval) {
          clearInterval(this.tabletRefreshInterval);
        }
        this.tabletRefreshInterval = setInterval(() => {
          const updatedClient = this.store.getClients()[this.currentClientIndex];
          this.renderTabletTable(updatedClient);
          this.updateTabletTotals(updatedClient);
        }, 3000);
      }

      async changeTabletWeek(direction) {
        this.weekOffset += direction;
        const clients = await this.store.getClients();
        const client = clients[this.currentClientIndex];
        await this.openTabletReadonlyView(this.currentClientIndex, client);
      }

      async resetTabletToCurrentWeek() {
        this.weekOffset = 0;
        const clients = await this.store.getClients();
        const client = clients[this.currentClientIndex];
        await this.openTabletReadonlyView(this.currentClientIndex, client);
      }

      async downloadTabletPNG() {
        const clients = await this.store.getClients();
        const client = clients[this.currentClientIndex];
        
        const { start, end } = OrderManager.getWeekDates(client.weekRange, this.weekOffset);
        const startFormatted = OrderManager.formatDate(start);
        const endFormatted = OrderManager.formatDate(end);
        const startStr = this.formatDateForDB(start);
        const endStr = this.formatDateForDB(end);
        
        // Calcular totales
        let gross = 0;
        let returns = 0;

        try {
          const orders = await this.store.getOrders(client.id, startStr, endStr) || {};
          
          for (const productName in orders) {
            const product = client.products.find(p => {
              const normalizedStoredName = p.name.toLowerCase().trim();
              const normalizedSearchName = productName.toLowerCase().trim();
              return normalizedStoredName === normalizedSearchName;
            });
            
            if (!product) {
              console.warn(`PNG - Producto "${productName}" no encontrado`);
              continue;
            }
            
            for (const fecha in orders[productName]) {
              const cantidad = parseInt(orders[productName][fecha]) || 0;
              gross += cantidad * product.price;
            }
          }

          if (client.allowReturns) {
            const returnsData = await this.store.getReturns(client.id, startStr, endStr) || {};
            
            for (const productName in returnsData) {
              const product = client.products.find(p => {
                const normalizedStoredName = p.name.toLowerCase().trim();
                const normalizedSearchName = productName.toLowerCase().trim();
                return normalizedStoredName === normalizedSearchName;
              });
              
              if (!product) continue;
              
              const isReturnable = product.name.toLowerCase().includes('croissant') || 
                                   product.name.toLowerCase().includes('chocolat√≠n');
              
              if (isReturnable) {
                for (const fecha in returnsData[productName]) {
                  const cantidad = parseInt(returnsData[productName][fecha]) || 0;
                  returns += cantidad * product.price;
                }
              }
            }
          }
        } catch (error) {
          console.error('Error al calcular totales:', error);
          alert('Error al calcular totales: ' + error.message);
          return;
        }

        const net = Math.max(0, gross - returns);
        const totals = { gross, returns, net };
        
        try {
          const canvas = await this.generateClientCanvas(client, startFormatted, endFormatted, totals);
          const imageData = canvas.toDataURL('image/png');
          
          const a = document.createElement('a');
          a.href = imageData;
          a.download = `${client.name} ${startFormatted}-${endFormatted}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        } catch (error) {
          console.error('Error al generar PNG:', error);
          alert('Error al generar PNG: ' + error.message);
        }
      }

      async renderTabletTable(client) {
        const startDate = document.getElementById('tabletStartDate').value;
        const endDate = document.getElementById('tabletEndDate').value;
        
        if (!startDate || !endDate) return;
        
        // Cargar datos de Supabase
        if (USE_SUPABASE && client.id) {
          this.currentOrders = await this.store.getOrders(client.id, startDate, endDate) || {};
          this.currentReturns = await this.store.getReturns(client.id, startDate, endDate) || {};
          this.mergeSupabaseData(client);
        }
        
        const days = OrderManager.getWeekDays(client.weekRange);
        const dates = OrderManager.getWeekDatesArray(client.weekRange, this.weekOffset);
        const thead = document.getElementById('tabletOrdersTableHead');
        const tbody = document.getElementById('tabletOrdersTableBody');

        thead.innerHTML = `
          <tr>
            <th>Producto</th>
            ${days.map((day, idx) => `
              <th style="min-width: 100px;">
                <div style="font-size: 11px; font-weight: 500; margin-bottom: 2px;">${day}</div>
                <div style="font-size: 13px; font-weight: 700;">${dates[idx].getDate()} ${OrderManager.formatDate(dates[idx]).split(' ')[1]}</div>
              </th>
            `).join('')}
            <th>Total</th>
          </tr>
        `;

        let html = '';
        client.products.forEach(product => {
          const productData = client.currentWeek.data[product.name];
          let weekTotal = 0;

          html += '<tr>';
          html += `<td><strong>${product.name}</strong></td>`;
          
          days.forEach(day => {
            const qty = productData[day] || 0;
            weekTotal += qty;
            html += `<td><strong>${qty || '‚Äî'}</strong></td>`;
          });

          html += `<td><strong>${weekTotal}</strong></td>`;
          html += '</tr>';
        });

        tbody.innerHTML = html;
      }

      async updateTabletTotals(client) {
        const startDate = document.getElementById('tabletStartDate').value;
        const endDate = document.getElementById('tabletEndDate').value;
        
        let gross = 0;
        let returns = 0;

        try {
          const orders = await this.store.getOrders(client.id, startDate, endDate) || {};
          
          console.log('Tablet totals - orders:', orders);
          
          for (const productName in orders) {
            const product = client.products.find(p => {
              // Buscar por nombre exacto o normalizado
              const normalizedStoredName = p.name.toLowerCase().trim();
              const normalizedSearchName = productName.toLowerCase().trim();
              return normalizedStoredName === normalizedSearchName;
            });
            
            if (!product) {
              console.warn(`Producto "${productName}" no encontrado en client.products`);
              continue;
            }
            
            for (const fecha in orders[productName]) {
              const cantidad = parseInt(orders[productName][fecha]) || 0;
              const subtotal = cantidad * product.price;
              gross += subtotal;
              console.log(`  ${productName}: ${cantidad} x $${product.price} = $${subtotal}`);
            }
          }

          console.log('Tablet totals - gross:', gross);

          if (client.allowReturns) {
            const returnsData = await this.store.getReturns(client.id, startDate, endDate) || {};
            
            for (const productName in returnsData) {
              const product = client.products.find(p => {
                const normalizedStoredName = p.name.toLowerCase().trim();
                const normalizedSearchName = productName.toLowerCase().trim();
                return normalizedStoredName === normalizedSearchName;
              });
              
              if (!product) continue;
              
              const isReturnable = product.name.toLowerCase().includes('croissant') || 
                                   product.name.toLowerCase().includes('chocolat√≠n');
              
              if (isReturnable) {
                for (const fecha in returnsData[productName]) {
                  const cantidad = parseInt(returnsData[productName][fecha]) || 0;
                  returns += cantidad * product.price;
                }
              }
            }
          }
        } catch (error) {
          console.error('Error al calcular totales tablet:', error);
        }

        const net = Math.max(0, gross - returns);
        
        console.log('Tablet totals final - gross:', gross, 'returns:', returns, 'net:', net);
        
        document.getElementById('tabletGrossTotal').textContent = `$${gross.toFixed(2)}`;
        document.getElementById('tabletReturnsTotal').textContent = `$${returns.toFixed(2)}`;
        document.getElementById('tabletNetTotal').textContent = `$${net.toFixed(2)}`;
      }

      async openDesktopOrderView(index, client) {
        this.showView('ordersView');
        
        document.getElementById('ordersClientName').textContent = client.name;
        
        const { start, end } = OrderManager.getWeekDates(client.weekRange, this.weekOffset);
        document.getElementById('ordersWeekRange').textContent = 
          `${OrderManager.formatDate(start)} - ${OrderManager.formatDate(end)}`;
        
        // Indicador de semana
        if (this.weekOffset !== 0) {
          const weekText = this.weekOffset < 0 ? `${Math.abs(this.weekOffset)} sem. atr√°s` : `${this.weekOffset} sem. adelante`;
          document.getElementById('ordersWeekRange').textContent += ` (${weekText})`;
        }

        await this.renderOrdersTable(client);
        await this.updateTotals(client);
      }

      async renderOrdersTable(client) {
        const days = OrderManager.getWeekDays(client.weekRange);
        const dates = OrderManager.getWeekDatesArray(client.weekRange, this.weekOffset);
        const thead = document.getElementById('ordersTableHead');
        const tbody = document.getElementById('ordersTableBody');

        // Cargar datos de Supabase para el rango actual
        if (USE_SUPABASE && client.id) {
          const { start, end } = OrderManager.getWeekDates(client.weekRange, this.weekOffset);
          const startStr = this.formatDateForDB(start);
          const endStr = this.formatDateForDB(end);
          
          this.currentOrders = await this.store.getOrders(client.id, startStr, endStr) || {};
          this.currentReturns = await this.store.getReturns(client.id, startStr, endStr) || {};
          
          // Actualizar estructura con datos de Supabase
          this.mergeSupabaseData(client);
        }

        thead.innerHTML = `
          <tr>
            <th>Producto</th>
            ${days.map((day, idx) => `
              <th style="min-width: 140px;">
                <div style="font-size: 11px; color: var(--text-secondary); font-weight: 500; margin-bottom: 2px;">${day}</div>
                <div style="font-size: 13px; font-weight: 700;">${dates[idx].getDate()} ${OrderManager.formatDate(dates[idx]).split(' ')[1]}</div>
              </th>
            `).join('')}
            <th>Total</th>
          </tr>
        `;

        let html = '';
        client.products.forEach(product => {
          const productData = client.currentWeek.data[product.name];
          let weekTotal = 0;

          html += '<tr>';
          html += `<td><strong>${product.name}</strong></td>`;
          
          days.forEach(day => {
            const qty = productData[day] || 0;
            weekTotal += qty;
            html += `
              <td>
                <div class="qty-group">
                  <input type="text" 
                         class="qty-input" 
                         value="${qty || ''}"
                         pattern="[0-9]*"
                         inputmode="numeric"
                         placeholder="0"
                         onchange="app.setQuantity('${product.name}', '${day}', this.value)"
                         onfocus="this.select()">
                </div>
              </td>
            `;
          });

          html += `<td><strong>${weekTotal}</strong></td>`;
          html += '</tr>';

          // FILA DE REGRESADOS DIARIOS (solo para Croissant y Chocolat√≠n)
          const isReturnable = client.allowReturns && 
            (product.name.toLowerCase() === 'croissant' || 
             product.name.toLowerCase() === 'chocolat√≠n');

          if (isReturnable) {
            const returnsData = productData.returns || {};
            let totalReturns = 0;
            
            html += '<tr style="background: rgba(255,59,48,0.05);">';
            html += `<td><strong>‚Ü©Ô∏è Regresados</strong></td>`;
            
            days.forEach(day => {
              const returnQty = returnsData[day] || 0;
              totalReturns += returnQty;
              html += `
                <td>
                  <div class="qty-group">
                    <input type="text" 
                           class="qty-input" 
                           style="border-color: var(--danger); color: var(--danger);"
                           value="${returnQty || ''}"
                           pattern="[0-9]*"
                           inputmode="numeric"
                           placeholder="0"
                           onchange="app.setDailyReturn('${product.name}', '${day}', this.value)"
                           onfocus="this.select()">
                  </div>
                </td>
              `;
            });

            html += `<td><strong style="color: var(--danger);">-${totalReturns}</strong></td>`;
            html += '</tr>';
          }
        });

        tbody.innerHTML = html;
      }

      async setQuantity(productName, day, value) {
        const client = this.currentClient;
        const qty = parseInt(value) || 0;
        client.currentWeek.data[productName][day] = Math.max(0, qty);
        
        // Guardar en Supabase si est√° disponible
        if (USE_SUPABASE && client.id) {
          const product = client.products.find(p => p.name === productName);
          if (product && product.id) {
            const fecha = this.convertDayToDate(day, client.weekRange);
            await this.store.setOrderQuantity(client.id, product.id, fecha, qty);
          }
        }
        
        await this.renderOrdersTable(client);
        await this.updateTotals(client);
      }

      async setDailyReturn(productName, day, value) {
        const client = this.currentClient;
        const qty = parseInt(value) || 0;
        
        if (!client.currentWeek.data[productName].returns) {
          client.currentWeek.data[productName].returns = {};
        }
        client.currentWeek.data[productName].returns[day] = Math.max(0, qty);
        
        // Guardar en Supabase si est√° disponible
        if (USE_SUPABASE && client.id) {
          const product = client.products.find(p => p.name === productName);
          if (product && product.id) {
            const fecha = this.convertDayToDate(day, client.weekRange);
            await this.store.setReturnQuantity(client.id, product.id, fecha, qty);
          }
        }
        
        await this.renderOrdersTable(client);
        await this.updateTotals(client);
      }

      async updateTotals(client) {
        // Obtener fechas del selector
        let startDate, endDate;
        const { start, end } = OrderManager.getWeekDates(client.weekRange, this.weekOffset);
        startDate = this.formatDateForDB(start);
        endDate = this.formatDateForDB(end);

        // Calcular totales usando Supabase
        let gross = 0;
        let returns = 0;

        try {
          // Obtener pedidos del rango
          const orders = await this.store.getOrders(client.id, startDate, endDate);
          
          // Calcular bruto
          for (const productName in orders) {
            const product = client.products.find(p => p.name === productName);
            if (!product) continue;
            
            for (const fecha in orders[productName]) {
              const cantidad = orders[productName][fecha];
              gross += cantidad * product.price;
            }
          }

          // Calcular regresados
          if (client.allowReturns) {
            const returnsData = await this.store.getReturns(client.id, startDate, endDate);
            
            for (const productName in returnsData) {
              const product = client.products.find(p => p.name === productName);
              if (!product) continue;
              
              const isReturnable = product.name.toLowerCase() === 'croissant' || 
                                   product.name.toLowerCase() === 'chocolat√≠n';
              
              if (isReturnable) {
                for (const fecha in returnsData[productName]) {
                  const cantidad = returnsData[productName][fecha];
                  returns += cantidad * product.price;
                }
              }
            }
          }
        } catch (error) {
          console.error('Error al calcular totales:', error);
        }

        const net = Math.max(0, gross - returns);

        document.getElementById('grossTotal').textContent = `$${gross.toFixed(2)}`;
        document.getElementById('returnsTotal').textContent = `$${returns.toFixed(2)}`;
        document.getElementById('netTotal').textContent = `$${net.toFixed(2)}`;
      }

      async resetWeek() {
        if (!confirm('¬øReiniciar toda la semana? Esta acci√≥n no se puede deshacer.')) return;

        const client = this.store.getClients()[this.currentClientIndex];
        const days = OrderManager.getWeekDays(client.weekRange);

        client.products.forEach(product => {
          days.forEach(day => {
            client.currentWeek.data[product.name][day] = 0;
          });
          client.currentWeek.data[product.name].weeklyReturned = 0;
        });

        this.store.updateClient(this.currentClientIndex, client);
        await this.renderOrdersTable(client);
        await this.updateTotals(client);
      }

      async exportWeek() {
        const clients = await this.store.getClients();
        const client = clients[this.currentClientIndex];
        
        // Obtener fechas del weekOffset actual
        const { start, end } = OrderManager.getWeekDates(client.weekRange, this.weekOffset);
        const startFormatted = OrderManager.formatDate(start);
        const endFormatted = OrderManager.formatDate(end);
        const startStr = this.formatDateForDB(start);
        const endStr = this.formatDateForDB(end);
        
        // Calcular totales desde Supabase
        let gross = 0;
        let returns = 0;

        try {
          const orders = await this.store.getOrders(client.id, startStr, endStr) || {};
          
          for (const productName in orders) {
            const product = client.products.find(p => p.name === productName);
            if (!product) continue;
            
            for (const fecha in orders[productName]) {
              const cantidad = orders[productName][fecha];
              gross += cantidad * product.price;
            }
          }

          if (client.allowReturns) {
            const returnsData = await this.store.getReturns(client.id, startStr, endStr) || {};
            
            for (const productName in returnsData) {
              const product = client.products.find(p => p.name === productName);
              if (!product) continue;
              
              const isReturnable = product.name.toLowerCase() === 'croissant' || 
                                   product.name.toLowerCase() === 'chocolat√≠n';
              
              if (isReturnable) {
                for (const fecha in returnsData[productName]) {
                  const cantidad = returnsData[productName][fecha];
                  returns += cantidad * product.price;
                }
              }
            }
          }
        } catch (error) {
          console.error('Error al calcular totales:', error);
        }

        const net = Math.max(0, gross - returns);
        const totals = { gross, returns, net };

        // Guardar en Supabase historial_semanas
        if (USE_SUPABASE && client.id) {
          try {
            const { data, error } = await supabaseClient
              .from('historial_semanas')
              .insert({
                cafeteria_id: client.id,
                fecha_inicio: startStr,
                fecha_fin: endStr,
                total_bruto: gross,
                total_regresados: returns,
                total_neto: net
              });

            if (error) {
              console.error('Error guardando historial:', error);
              alert('‚ö†Ô∏è Error al guardar en Supabase: ' + error.message);
              return;
            }

            alert('‚úÖ Semana guardada en el historial');
          } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al guardar: ' + error.message);
          }
        } else {
          // Fallback a localStorage
          if (!client.history) client.history = [];
          client.history.push({
            key: `${startFormatted}_${endFormatted}`,
            start: startFormatted,
            end: endFormatted,
            totals,
            data: JSON.parse(JSON.stringify(client.currentWeek.data)),
            savedAt: new Date().toISOString()
          });

          await this.store.updateClient(this.currentClientIndex, client);
          alert('‚úÖ Semana guardada en el historial (local)');
        }
      }

      viewHistory() {
        const client = this.store.getClients()[this.currentClientIndex];
        
        this.showView('historyView');
        
        document.getElementById('historyClientName').textContent = `Historial - ${client.name}`;
        
        const historyList = document.getElementById('historyList');
        
        if (!client.history || client.history.length === 0) {
          historyList.innerHTML = `
            <div class="empty-state" style="padding: 40px 20px;">
              <div class="empty-state-icon">üìÖ</div>
              <h3>Sin historial</h3>
              <p>A√∫n no has guardado ninguna semana</p>
            </div>
          `;
        } else {
          historyList.innerHTML = client.history.map((week, index) => `
            <div class="card" style="cursor: default; margin-bottom: 16px;">
              <div class="card-label">Semana ${client.history.length - index}</div>
              <div class="card-title">${week.start} - ${week.end}</div>
              <div style="display: flex; gap: 16px; margin-top: 12px; flex-wrap: wrap;">
                <div>
                  <div class="text-secondary" style="font-size: 12px; margin-bottom: 4px;">Total Bruto</div>
                  <div style="font-size: 18px; font-weight: 600; color: var(--text);">$${week.totals.gross.toFixed(2)}</div>
                </div>
                <div>
                  <div class="text-secondary" style="font-size: 12px; margin-bottom: 4px;">Regresados</div>
                  <div style="font-size: 18px; font-weight: 600; color: var(--danger);">$${week.totals.returns.toFixed(2)}</div>
                </div>
                <div>
                  <div class="text-secondary" style="font-size: 12px; margin-bottom: 4px;">Total Neto</div>
                  <div style="font-size: 18px; font-weight: 600; color: var(--success);">$${week.totals.net.toFixed(2)}</div>
                </div>
              </div>
              <div style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                Guardado: ${new Date(week.savedAt).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' })}
              </div>
              <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button class="btn-secondary" style="flex: 1;" onclick="app.downloadWeekImage(${index})">Descargar PNG</button>
                <button class="btn-danger" onclick="app.deleteHistoryWeek(${index})">Eliminar</button>
              </div>
            </div>
          `).reverse().join('');
        }
      }

      async downloadWeekImage(historyIndex) {
        const client = this.store.getClients()[this.currentClientIndex];
        const week = client.history[historyIndex];
        
        if (!week) return;
        
        const canvas = await this.generateClientCanvas(client, week.start, week.end, week.totals, week.data);
        const imageData = canvas.toDataURL('image/png');
        
        const a = document.createElement('a');
        a.href = imageData;
        a.download = `${client.name} ${week.start}-${week.end}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      deleteHistoryWeek(historyIndex) {
        if (!confirm('¬øEliminar esta semana del historial?')) return;
        
        const client = this.store.getClients()[this.currentClientIndex];
        client.history.splice(historyIndex, 1);
        this.store.updateClient(this.currentClientIndex, client);
        this.viewHistory();
      }

      showImportModal() {
        this.openModal('importModal');
      }

      importCSV() {
        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];
        
        if (!file) {
          alert('Selecciona un archivo CSV');
          return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
          const text = e.target.result;
          await this.parseCSV(text);
        };
        reader.readAsText(file);
      }

      async parseCSV(text) {
        const lines = text.split(/\r?\n/).filter(l => l.trim());
        const clientsMap = {};

        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',').map(c => c.trim());
          const cafeName = cols[0];
          
          if (!cafeName) continue;

          if (!clientsMap[cafeName]) {
            clientsMap[cafeName] = {
              name: cafeName,
              color: '#5ac8fa', // Color por defecto
              weekRange: cols[4] || 'mon-sat',
              allowReturns: cols[3] && cols[3].toLowerCase() === 'si',
              products: [],
              currentWeek: null,
              history: []
            };
          }

          clientsMap[cafeName].products.push({
            id: `prod-${Date.now()}-${Math.random()}`,
            name: cols[1],
            price: parseFloat(cols[2]) || 0
          });
        }

        // Importar todas las cafeter√≠as de forma as√≠ncrona
        const clients = Object.values(clientsMap);
        let successCount = 0;
        let errorCount = 0;

        for (const client of clients) {
          try {
            await this.store.addClient(client);
            successCount++;
          } catch (error) {
            console.error('Error al importar cafeter√≠a:', client.name, error);
            errorCount++;
          }
        }

        this.closeModal('importModal');
        await this.renderClients();
        
        if (errorCount > 0) {
          alert(`‚ö†Ô∏è Se importaron ${successCount} cafeter√≠as con √©xito, ${errorCount} con errores. Revisa la consola para m√°s detalles.`);
        } else {
          alert(`‚úÖ ${successCount} cafeter√≠as importadas correctamente a Supabase`);
        }
      }

      async migrateToSupabase() {
        if (!USE_SUPABASE) {
          alert('‚ö†Ô∏è Supabase no est√° configurado. Verifica tus credenciales.');
          return;
        }

        const confirmMigration = confirm('üîÑ ¬øMigrar datos de localStorage a Supabase?\n\nEsto subir√° todas las cafeter√≠as locales a la nube.\n\n‚ö†Ô∏è Si ya existen cafeter√≠as en Supabase, se duplicar√°n.');
        
        if (!confirmMigration) return;

        try {
          // Leer datos de localStorage
          const localData = localStorage.getItem('panfitrion_v2');
          
          if (!localData) {
            alert('‚ÑπÔ∏è No hay datos en localStorage para migrar.');
            return;
          }

          const data = JSON.parse(localData);
          const localClients = data.clients || [];

          if (localClients.length === 0) {
            alert('‚ÑπÔ∏è No hay cafeter√≠as en localStorage para migrar.');
            return;
          }

          let successCount = 0;
          let errorCount = 0;

          // Migrar cada cafeter√≠a
          for (const client of localClients) {
            try {
              console.log('Migrando:', client.name);
              
              // Preparar estructura para Supabase
              const clientToMigrate = {
                name: client.name,
                color: client.color || '#5ac8fa',
                weekRange: client.weekRange || 'mon-sat',
                allowReturns: client.allowReturns || false,
                products: client.products.map(p => ({
                  id: p.id || `prod-${Date.now()}-${Math.random()}`,
                  name: p.name,
                  price: p.price || 0
                }))
              };

              // Agregar a Supabase
              const cafeteriaId = await this.store.addClient(clientToMigrate);
              
              // Migrar pedidos si existen
              if (client.currentWeek && client.currentWeek.data) {
                await this.migrateOrders(cafeteriaId, client);
              }

              successCount++;
              console.log('‚úÖ Migrada:', client.name);
            } catch (error) {
              console.error('‚ùå Error migrando:', client.name, error);
              errorCount++;
            }
          }

          await this.renderClients();
          
          if (errorCount > 0) {
            alert(`‚ö†Ô∏è Migraci√≥n completada:\n‚úÖ ${successCount} exitosas\n‚ùå ${errorCount} con errores\n\nRevisa la consola para detalles.`);
          } else {
            alert(`‚úÖ Migraci√≥n exitosa!\n\n${successCount} cafeter√≠as migradas a Supabase.\n\nYa puedes eliminar los datos de localStorage si lo deseas.`);
          }

        } catch (error) {
          console.error('Error en migraci√≥n:', error);
          alert('‚ùå Error durante la migraci√≥n: ' + error.message);
        }
      }

      async migrateOrders(cafeteriaId, client) {
        // Esta funci√≥n migra los pedidos del formato antiguo (currentWeek.data)
        // al nuevo formato de Supabase (pedidos por fecha)
        try {
          const weekData = client.currentWeek.data;
          const dates = OrderManager.getWeekDates(client.weekRange, 0);
          const daysArray = OrderManager.getWeekDatesArray(dates.start, dates.end);

          for (const productName of Object.keys(weekData)) {
            const product = client.products.find(p => p.name === productName);
            if (!product) continue;

            const productData = weekData[productName];
            
            for (let i = 0; i < daysArray.length; i++) {
              const fecha = daysArray[i];
              const dayName = OrderManager.getDayNames(client.weekRange)[i];
              const cantidad = productData[dayName] || 0;

              if (cantidad > 0) {
                await this.store.setOrderQuantity(cafeteriaId, product.id, fecha, cantidad);
              }

              // Migrar regresados si existen
              if (productData.returns && productData.returns[dayName]) {
                const returnQty = productData.returns[dayName];
                if (returnQty > 0) {
                  await this.store.setReturnQuantity(cafeteriaId, product.id, fecha, returnQty);
                }
              }
            }
          }
          
          console.log('  üìä Pedidos migrados para:', client.name);
        } catch (error) {
          console.error('  ‚ö†Ô∏è Error migrando pedidos:', error);
        }
      }

      clearLocalStorage() {
        const confirmClear = confirm('üóëÔ∏è ¬øEliminar TODOS los datos de localStorage?\n\n‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n NO se puede deshacer.\n\n‚úÖ Aseg√∫rate de haber migrado tus datos a Supabase antes de continuar.\n\n¬øDeseas continuar?');
        
        if (!confirmClear) return;

        const doubleConfirm = confirm('‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\nEsto borrar√° permanentemente:\n- Todas las cafeter√≠as locales\n- Todos los pedidos guardados\n- Todo el historial\n\n¬øEst√°s SEGURO?');
        
        if (!doubleConfirm) return;

        try {
          // Eliminar datos de localStorage
          localStorage.removeItem('panfitrion_v2');
          localStorage.removeItem('panfitrion_data'); // Por si existe versi√≥n antigua
          
          console.log('‚úÖ localStorage eliminado');
          alert('‚úÖ Datos locales eliminados correctamente.\n\nAhora solo usar√°s Supabase.\n\nRecarga la p√°gina para ver los cambios.');
          
          // Recargar p√°gina
          location.reload();
        } catch (error) {
          console.error('Error al eliminar localStorage:', error);
          alert('‚ùå Error al eliminar datos: ' + error.message);
        }
      }

      async exportAllPDF() {
        const clients = this.store.getClients();
        
        if (clients.length === 0) {
          alert('No hay cafeter√≠as para exportar');
          return;
        }

        let generalStart, generalEnd;
        const globalRange = this.store.data.globalDateRange || {};
        
        if (globalRange.start && globalRange.end) {
          generalStart = new Date(globalRange.start + 'T00:00:00');
          generalEnd = new Date(globalRange.end + 'T00:00:00');
        } else {
          const firstClient = clients[0];
          
          if (firstClient.customDateRange && firstClient.customDateRange.start && firstClient.customDateRange.end) {
            generalStart = new Date(firstClient.customDateRange.start + 'T00:00:00');
            generalEnd = new Date(firstClient.customDateRange.end + 'T00:00:00');
          } else {
            const dates = OrderManager.getWeekDates(firstClient.weekRange);
            generalStart = dates.start;
            generalEnd = dates.end;
          }
        }

        const folderName = `${OrderManager.formatDate(generalStart)}-${OrderManager.formatDate(generalEnd)}`;
        const zip = new JSZip();
        const folder = zip.folder(folderName);

        for (let i = 0; i < clients.length; i++) {
          const client = clients[i];
          OrderManager.initWeekStructure(client);
          
          let clientStart, clientEnd;
          if (client.customDateRange && client.customDateRange.start && client.customDateRange.end) {
            clientStart = new Date(client.customDateRange.start + 'T00:00:00');
            clientEnd = new Date(client.customDateRange.end + 'T00:00:00');
          } else {
            const dates = OrderManager.getWeekDates(client.weekRange);
            clientStart = dates.start;
            clientEnd = dates.end;
          }

          const startFormatted = OrderManager.formatDate(clientStart);
          const endFormatted = OrderManager.formatDate(clientEnd);
          const totals = OrderManager.calculateTotals(client);
          
          const canvas = await this.generateClientCanvas(client, startFormatted, endFormatted, totals);
          const imageData = canvas.toDataURL('image/png');
          const base64Data = imageData.split(',')[1];
          
          const fileName = `${client.name} ${startFormatted}-${endFormatted}.png`;
          folder.file(fileName, base64Data, {base64: true});
        }

        const content = await zip.generateAsync({type: 'blob'});
        const url = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${folderName}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('‚úÖ Carpeta exportada correctamente');
      }

      async generateClientCanvas(client, startFormatted, endFormatted, totals, customData = null) {
        const days = OrderManager.getWeekDays(client.weekRange);
        const data = customData || client.currentWeek.data;
        
        const wrapText = (ctx, text, maxWidth) => {
          const words = text.split(' ');
          const lines = [];
          let currentLine = words[0];

          for (let i = 1; i < words.length; i++) {
            const testLine = currentLine + ' ' + words[i];
            const metrics = ctx.measureText(testLine);
            if (metrics.width > maxWidth) {
              lines.push(currentLine);
              currentLine = words[i];
            } else {
              currentLine = testLine;
            }
          }
          lines.push(currentLine);
          return lines;
        };
        
        const rows = [];
        rows.push(['Producto', ...days, 'Total']);
        
        client.products.forEach(product => {
          if (!data[product.name]) return;
          
          const row = [product.name];
          let weekTotal = 0;
          
          days.forEach(day => {
            const qty = data[product.name][day] || 0;
            row.push(String(qty));
            weekTotal += qty;
          });
          
          row.push(String(weekTotal));
          rows.push(row);
          
          const isReturnable = client.allowReturns && 
            (product.name.toLowerCase() === 'croissant' || 
             product.name.toLowerCase() === 'chocolat√≠n');
          
          if (isReturnable) {
            const returnQty = data[product.name].weeklyReturned || 0;
            const returnRow = [`Regresados (${product.name})`];
            days.forEach(() => returnRow.push('‚Äî'));
            returnRow.push(String(returnQty));
            rows.push(returnRow);
          }
        });

        const cellW = 130;
        const cellH = 55;
        const cols = rows[0].length;
        const rowsCount = rows.length;
        const pad = 30;
        const headerHeight = 100;
        const width = pad * 2 + cellW * cols;
        const height = pad * 2 + headerHeight + cellH * rowsCount;
        
        const canvas = document.createElement('canvas');
        canvas.width = width * 2;
        canvas.height = height * 2;
        const ctx = canvas.getContext('2d');
        ctx.scale(2, 2);

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, width, height);

        ctx.fillStyle = '#1d1d1f';
        ctx.font = 'bold 22px -apple-system, Arial';
        ctx.fillText(client.name, pad, pad + 25);
        
        ctx.font = '14px -apple-system, Arial';
        ctx.fillStyle = '#86868b';
        ctx.fillText(`${startFormatted} a ${endFormatted}`, pad, pad + 50);
        
        ctx.fillStyle = '#0a84ff';
        ctx.font = 'bold 16px -apple-system, Arial';
        ctx.fillText(`Total Neto: $${totals.net.toFixed(2)}`, pad, pad + 75);

        const tableTop = pad + headerHeight;
        ctx.textBaseline = 'middle';

        ctx.textAlign = 'center';
        for (let c = 0; c < cols; c++) {
          const x = pad + c * cellW;
          const y = tableTop;
          
          ctx.fillStyle = '#f5f5f7';
          ctx.fillRect(x, y, cellW, cellH);
          ctx.strokeStyle = '#d2d2d7';
          ctx.strokeRect(x, y, cellW, cellH);
          
          ctx.fillStyle = '#1d1d1f';
          ctx.font = 'bold 13px -apple-system, Arial';
          ctx.fillText(rows[0][c], x + cellW / 2, y + cellH / 2);
        }

        ctx.font = '11px -apple-system, Arial';
        for (let r = 1; r < rowsCount; r++) {
          for (let c = 0; c < cols; c++) {
            const x = pad + c * cellW;
            const y = tableTop + r * cellH;
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(x, y, cellW, cellH);
            ctx.strokeStyle = '#d2d2d7';
            ctx.strokeRect(x, y, cellW, cellH);
            
            ctx.fillStyle = '#1d1d1f';
            
            if (c === 0) {
              ctx.textAlign = 'left';
              const lines = wrapText(ctx, rows[r][c], cellW - 16);
              const lineHeight = 14;
              const totalHeight = lines.length * lineHeight;
              const startY = y + cellH / 2 - totalHeight / 2 + lineHeight / 2;
              
              lines.forEach((line, idx) => {
                ctx.fillText(line, x + 8, startY + idx * lineHeight);
              });
            } else {
              ctx.textAlign = 'center';
              ctx.fillText(rows[r][c], x + cellW / 2, y + cellH / 2);
            }
          }
        }

        return canvas;
      }

      openModal(id) {
        document.getElementById(id).classList.add('active');
      }

      closeModal(id) {
        document.getElementById(id).classList.remove('active');
      }

      toggleMobileCafesMenu() {
        const menu = document.getElementById('mobileCafesMenu');
        menu.classList.toggle('active');
      }

      async renderMobileCafesList() {
        const clients = await this.store.getClients();
        const list = document.getElementById('mobileCafesList');
        
        if (!list) return;
        
        if (clients.length === 0) {
          list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No hay cafeter√≠as registradas</div>';
          return;
        }
        
        list.innerHTML = clients.map((client, index) => {
          const bgColor = client.color || '#5ac8fa';
          const textColor = this.getContrastColor(bgColor);
          return `
            <button class="mobile-cafe-item" style="background: ${bgColor}; color: ${textColor};" onclick="app.openOrders(${index}); app.toggleMobileCafesMenu();">
              ${client.name}
            </button>
          `;
        }).join('');
      }
    }

    const app = new App();
    
    // Exponer app globalmente para event handlers
    window.app = app;
  </script>

  <!-- Men√∫ m√≥vil de cafeter√≠as -->
  <button class="mobile-menu-toggle" onclick="app.toggleMobileCafesMenu()">
    ‚ò∞
  </button>

  <div class="mobile-cafes-menu" id="mobileCafesMenu">
    <div class="mobile-cafes-menu-header">
      <span>Cafeter√≠as</span>
      <button class="icon-btn" onclick="app.toggleMobileCafesMenu()" style="font-size: 24px;">‚úï</button>
    </div>
    <div class="mobile-cafes-list" id="mobileCafesList">
      <!-- Se llenar√°n din√°micamente -->
    </div>
  </div>
</body>
</html>
